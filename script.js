// Global variables
let events = [];
let selectedDate = new Date();
let currentMonth = new Date();
let editingEvent = null;
let notificationSystem = null;

// Event types and their labels
const EVENT_TYPES = {
    assignment: 'Í≥ºÏ†ú',
    exam: 'ÏãúÌóò', 
    lecture: 'Í∞ïÏùò',
    meeting: 'ÎØ∏ÌåÖ',
    academic: 'ÌïôÏÇ¨ÏùºÏ†ï',
    personal: 'Í∞úÏù∏ÏùºÏ†ï'
};

// Event type icons
const EVENT_TYPE_ICONS = {
    assignment: 'üìù',
    exam: 'üìö',
    lecture: 'üéì',
    meeting: 'üë•',
    academic: 'üè´',
    personal: 'üåü'
};

// Priority labels
const PRIORITY_LABELS = {
    high: 'ÎÜíÏùå',
    medium: 'Ï§ëÍ∞Ñ',
    low: 'ÎÇÆÏùå'
};

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    initCalendar();
    initEventHandlers();
    loadEvents();
    updateCalendar();
    updateEventList();
    
    // ÏïåÎ¶º ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî
    notificationSystem = new NotificationSystem();
});

// Initialize calendar
function initCalendar() {
    updateMonthDisplay();
}

// Initialize event handlers
function initEventHandlers() {
    // Calendar navigation
    document.getElementById('prev-month').addEventListener('click', prevMonth);
    document.getElementById('next-month').addEventListener('click', nextMonth);
    
    // Event form
    document.getElementById('add-event-btn').addEventListener('click', showEventForm);
    document.getElementById('cancel-btn').addEventListener('click', hideEventForm);
    document.getElementById('event-form').addEventListener('submit', saveEvent);
    
    // Tab navigation
    document.getElementById('events-tab').addEventListener('click', () => switchTab('events'));
    document.getElementById('chatbot-tab').addEventListener('click', () => switchTab('chatbot'));
    
    // Chatbot
    document.getElementById('chatbot-send').addEventListener('click', analyzeChatbotInput);
    document.getElementById('chatbot-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
            analyzeChatbotInput();
        }
    });
    
    // Extracted info actions
    document.getElementById('save-extracted').addEventListener('click', saveExtractedEvent);
    document.getElementById('edit-extracted').addEventListener('click', editExtractedEvent);
}

// Date utility functions
function formatDate(date) {
    return date.getFullYear() + '-' + 
           String(date.getMonth() + 1).padStart(2, '0') + '-' + 
           String(date.getDate()).padStart(2, '0');
}

function isSameDay(date1, date2) {
    return date1.getDate() === date2.getDate() &&
           date1.getMonth() === date2.getMonth() &&
           date1.getFullYear() === date2.getFullYear();
}

function isSameMonth(date1, date2) {
    return date1.getMonth() === date2.getMonth() &&
           date1.getFullYear() === date2.getFullYear();
}

function formatDateKorean(date) {
    return `${date.getFullYear()}ÎÖÑ ${date.getMonth() + 1}Ïõî ${date.getDate()}Ïùº`;
}

// Calendar functions
function prevMonth() {
    currentMonth.setMonth(currentMonth.getMonth() - 1);
    updateCalendar();
    updateMonthDisplay();
}

function nextMonth() {
    currentMonth.setMonth(currentMonth.getMonth() + 1);
    updateCalendar();
    updateMonthDisplay();
}

function updateMonthDisplay() {
    const monthElement = document.getElementById('current-month');
    monthElement.textContent = `${currentMonth.getFullYear()}ÎÖÑ ${currentMonth.getMonth() + 1}Ïõî`;
}

function updateCalendar() {
    const calendarBody = document.getElementById('calendar-body');
    calendarBody.innerHTML = '';
    
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    
    // Get first day of month and last day of month
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    // Get first day of calendar (start of week)
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    // Get last day of calendar (end of week)
    const endDate = new Date(lastDay);
    endDate.setDate(endDate.getDate() + (6 - lastDay.getDay()));
    
    let currentDate = new Date(startDate);
    
    while (currentDate <= endDate) {
        const row = document.createElement('div');
        row.className = 'calendar-row';
        
        for (let i = 0; i < 7; i++) {
            const cell = document.createElement('div');
            cell.className = 'calendar-cell';
            
            // Add classes
            if (!isSameMonth(currentDate, currentMonth)) {
                cell.classList.add('disabled');
            }
            if (isSameDay(currentDate, selectedDate)) {
                cell.classList.add('selected');
            }
            
            // Check for events on this day
            const dayEvents = getDayEvents(currentDate);
            if (dayEvents.length > 0) {
                cell.classList.add('has-events');
            }
            
            // Create cell content
            const dateNumber = document.createElement('span');
            dateNumber.className = 'number';
            dateNumber.textContent = currentDate.getDate();
            cell.appendChild(dateNumber);
            
            // Add event dots
            const eventDots = document.createElement('div');
            eventDots.className = 'event-dots';
            
            for (let j = 0; j < Math.min(dayEvents.length, 3); j++) {
                const dot = document.createElement('span');
                dot.className = 'event-dot';
                eventDots.appendChild(dot);
            }
            
            if (dayEvents.length > 3) {
                const moreDot = document.createElement('span');
                moreDot.className = 'more-events';
                moreDot.textContent = `+${dayEvents.length - 3}`;
                eventDots.appendChild(moreDot);
            }
            
            cell.appendChild(eventDots);
            
            // Add click handler
            const dateToSelect = new Date(currentDate);
            cell.addEventListener('click', () => {
                selectDate(dateToSelect);
            });
            
            row.appendChild(cell);
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        calendarBody.appendChild(row);
    }
}

function selectDate(date) {
    selectedDate = new Date(date);
    updateCalendar();
    updateEventList();
    hideEventForm();
}

function getDayEvents(date) {
    return events.filter(event => isSameDay(new Date(event.date), date));
}

// Event management functions
function showEventForm(event = null) {
    editingEvent = event;
    const form = document.getElementById('event-form');
    const addButton = document.getElementById('add-event-btn');
    const formTitle = document.getElementById('form-title');
    
    if (event) {
        formTitle.textContent = 'ÏùºÏ†ï ÏàòÏ†ï';
        populateForm(event);
    } else {
        formTitle.textContent = 'ÏÉà ÏùºÏ†ï Ï∂îÍ∞Ä';
        clearForm();
        document.getElementById('date').value = formatDate(selectedDate);
    }
    
    form.classList.remove('hidden');
    addButton.classList.add('hidden');
}

function hideEventForm() {
    const form = document.getElementById('event-form');
    const addButton = document.getElementById('add-event-btn');
    
    form.classList.add('hidden');
    addButton.classList.remove('hidden');
    editingEvent = null;
    clearForm();
}

function populateForm(event) {
    document.getElementById('title').value = event.title;
    document.getElementById('type').value = event.type;
    document.getElementById('date').value = formatDate(new Date(event.date));
    document.getElementById('time').value = event.time;
    document.getElementById('end-time').value = event.endTime;
    document.getElementById('priority').value = event.priority;
    document.getElementById('description').value = event.description || '';
}

function clearForm() {
    document.getElementById('title').value = '';
    document.getElementById('type').value = 'assignment';
    document.getElementById('date').value = formatDate(selectedDate);
    document.getElementById('time').value = '09:00';
    document.getElementById('end-time').value = '10:00';
    document.getElementById('priority').value = 'medium';
    document.getElementById('description').value = '';
}

function saveEvent(e) {
    e.preventDefault();
    
    const form = document.getElementById('event-form');
    const formData = new FormData(form);
    
    const eventData = {
        id: editingEvent ? editingEvent.id : Date.now(),
        title: formData.get('title'),
        type: formData.get('type'),
        date: formData.get('date'),
        time: formData.get('time'),
        endTime: formData.get('end-time'),
        priority: formData.get('priority'),
        description: formData.get('description'),
        color: editingEvent ? editingEvent.color : null
    };
    
    // Î∂ÑÏÑù Î∞è Ïö∞ÏÑ†ÏàúÏúÑ Í≥ÑÏÇ∞
    const analysis = analyzeAssignment(eventData.title + ' ' + eventData.description);
    eventData.difficulty = analysis.difficulty;
    eventData.estimatedHours = analysis.estimatedHours;
    eventData.priority = calculatePriority(eventData);
    
    // Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÏÉùÏÑ±
    const checklist = generateChecklist(eventData.type);
    localStorage.setItem(`checklist-${eventData.id}`, JSON.stringify(
        checklist.map(task => ({ text: task, completed: false }))
    ));
    
    if (editingEvent) {
        const index = events.findIndex(e => e.id === editingEvent.id);
        if (index !== -1) {
            events[index] = { ...events[index], ...eventData };
        }
    } else {
        events.push(eventData);
    }
    
    saveEvents();
    updateCalendar();
    updateEventList();
    hideEventForm();
    editingEvent = null;
    
    // ÏïåÎ¶º ÏÑ§Ï†ï
    if (notificationSystem) {
        notificationSystem.createReminder(eventData);
    }
}

function deleteEvent(id) {
    if (confirm('Ïù¥ ÏùºÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
        events = events.filter(event => event.id !== id);
        saveEvents();
        updateCalendar();
        updateEventList();
    }
}

function editEvent(event) {
    showEventForm(event);
}

// Event list functions
function updateEventList() {
    const dayEvents = getDayEvents(selectedDate);
    const eventContainer = document.getElementById('event-container');
    const dateStr = formatDateKorean(selectedDate);
    
    const header = document.createElement('div');
    header.className = 'event-list-header';
    header.innerHTML = `
        <h3>${dateStr}</h3>
        <span class="event-count">${dayEvents.length}Í∞úÏùò Í≥ºÏ†ú</span>
    `;
    
    if (dayEvents.length === 0) {
        eventContainer.innerHTML = '';
        eventContainer.appendChild(header);
        const noEvents = document.createElement('p');
        noEvents.className = 'no-events';
        noEvents.textContent = 'Ïù¥ ÎÇ†ÏßúÏóê Îì±Î°ùÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§.';
        eventContainer.appendChild(noEvents);
        return;
    }
    
    eventContainer.innerHTML = '';
    eventContainer.appendChild(header);
    
    dayEvents.forEach(event => {
        const eventElement = createEventElement(event);
        eventContainer.appendChild(eventElement);
    });
}

function createEventElement(event) {
    const eventDiv = document.createElement('div');
    eventDiv.className = `event-item priority-${event.priority}`;
    
    const progress = trackProgress(event);
    const status = progress.isDelayed ? 'delayed' : 'on-track';
    const statusText = progress.isDelayed ? 'ÏßÄÏó∞' : 'Ï†ïÏÉÅ';
    
    eventDiv.innerHTML = `
        <div class="event-status">
            <span class="status-dot status-${status}"></span>
            <span>${statusText}</span>
            <div class="event-actions">
                <button class="edit-button" onclick="editEvent(${JSON.stringify(event).replace(/"/g, '&quot;')})">
                    ‚úèÔ∏è
                </button>
                <button class="delete-button" onclick="deleteEvent('${event.id}')">
                    üóëÔ∏è
                </button>
            </div>
        </div>
        <h4 class="event-title">${event.title}</h4>
        <div class="event-meta">
            <span>${event.time} - ${event.endTime}</span>
            ${event.type === 'assignment' ? 
                `<span class="event-points">ÏòàÏÉÅ ÏÜåÏöî: ${event.estimatedHours}ÏãúÍ∞Ñ</span>` : 
                ''}
        </div>
        <div class="progress-bar">
            <div class="progress" style="width: ${progress.currentProgress}%"></div>
            <div class="expected-progress" style="left: ${progress.expectedProgress}%"></div>
        </div>
    `;
    
    return eventDiv;
}

// Tab switching
function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    document.getElementById(`${tabName}-tab`).classList.add('active');
    document.getElementById(`${tabName}-content`).classList.add('active');
}

// Chatbot functions
let extractedData = null;

function analyzeChatbotInput() {
    const input = document.getElementById('chatbot-input');
    const text = input.value.trim();
    
    if (!text) {
        return;
    }
    
    // Add user message to chat
    addChatMessage(text, 'user');
    
    // Clear input
    input.value = '';
    
    // Show loading
    const loadingId = addChatMessage('Î∂ÑÏÑù Ï§ë<span class="loading-dots"></span>', 'bot');
    
    // Simulate processing time
    setTimeout(() => {
        // Remove loading message
        document.getElementById(loadingId).remove();
        
        // Extract information
        const extracted = extractAssignmentInfo(text);
        extractedData = extracted;
        
        // Show bot response
        let response = 'Í≥ºÏ†ú Ï†ïÎ≥¥Î•º Î∂ÑÏÑùÌñàÏäµÎãàÎã§!\n\n';
        response += `üìù Í≥ºÏ†úÎ™Ö: ${extracted.title}\n`;
        response += `üìÖ ÎßàÍ∞êÏùº: ${extracted.deadline}\n`;
        response += `üíØ Î∞∞Ï†ê: ${extracted.points}\n`;
        response += `üìç Ï†úÏ∂úÏû•ÏÜå: ${extracted.location}\n\n`;
        response += 'ÏïÑÎûòÏóêÏÑú Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÍ≥† Ï∫òÎ¶∞ÎçîÏóê Ï†ÄÏû•Ìï¥Ï£ºÏÑ∏Ïöî.';
        
        addChatMessage(response, 'bot');
        
        // Show extracted info panel
        displayExtractedInfo(extracted);
    }, 1500);
}

function addChatMessage(message, sender) {
    const messagesContainer = document.getElementById('chatbot-messages');
    const messageDiv = document.createElement('div');
    const messageId = 'msg-' + Date.now();
    messageDiv.id = messageId;
    messageDiv.className = sender === 'user' ? 'user-message' : 'bot-message';
    
    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';
    contentDiv.innerHTML = message.replace(/\n/g, '<br>');
    
    messageDiv.appendChild(contentDiv);
    messagesContainer.appendChild(messageDiv);
    
    // Scroll to bottom
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
}

function extractAssignmentInfo(text) {
    const extracted = {
        title: 'Ïïå Ïàò ÏóÜÏùå',
        deadline: 'Ïïå Ïàò ÏóÜÏùå',
        points: 'Ïïå Ïàò ÏóÜÏùå',
        location: 'Ïïå Ïàò ÏóÜÏùå'
    };
    
    // Extract title - look for common patterns
    const titlePatterns = [
        /Í≥ºÏ†ú[\s]*[:Ôºö]\s*(.+?)(?=\n|ÎßàÍ∞ê|Ï†úÏ∂ú|Î∞∞Ï†ê|Ï†êÏàò)/i,
        /Ï†úÎ™©[\s]*[:Ôºö]\s*(.+?)(?=\n|ÎßàÍ∞ê|Ï†úÏ∂ú|Î∞∞Ï†ê|Ï†êÏàò)/i,
        /Ï£ºÏ†ú[\s]*[:Ôºö]\s*(.+?)(?=\n|ÎßàÍ∞ê|Ï†úÏ∂ú|Î∞∞Ï†ê|Ï†êÏàò)/i,
        /[\[<„Äê](.+?)[\]>„Äë]/,
        /^(.+?)(?=Í≥ºÏ†ú|assignment|homework)/i
    ];
    
    for (const pattern of titlePatterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
            extracted.title = match[1].trim();
            break;
        }
    }
    
    // Extract deadline - look for date patterns
    const deadlinePatterns = [
        /ÎßàÍ∞êÏùº?[\s]*[:Ôºö]\s*(\d{4}[-\/ÎÖÑ]\s*\d{1,2}[-\/Ïõî]\s*\d{1,2}Ïùº?)/i,
        /Ï†úÏ∂úÏùº?[\s]*[:Ôºö]\s*(\d{4}[-\/ÎÖÑ]\s*\d{1,2}[-\/Ïõî]\s*\d{1,2}Ïùº?)/i,
        /Í∏∞Ìïú[\s]*[:Ôºö]\s*(\d{4}[-\/ÎÖÑ]\s*\d{1,2}[-\/Ïõî]\s*\d{1,2}Ïùº?)/i,
        /(\d{4}[-\/ÎÖÑ]\s*\d{1,2}[-\/Ïõî]\s*\d{1,2}Ïùº?)ÍπåÏßÄ/i,
        /(\d{1,2}\/\d{1,2}\/?\d{0,4})/,
        /(\d{1,2}Ïõî\s*\d{1,2}Ïùº)/,
        /(\d{4}-\d{1,2}-\d{1,2})/
    ];
    
    for (const pattern of deadlinePatterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
            extracted.deadline = match[1].trim();
            break;
        }
    }
    
    // Extract points - look for score patterns
    const pointsPatterns = [
        /Î∞∞Ï†ê[\s]*[:Ôºö]\s*(\d+)\s*Ï†ê/i,
        /Ï†êÏàò[\s]*[:Ôºö]\s*(\d+)\s*Ï†ê/i,
        /(\d+)\s*Ï†ê\s*ÎßåÏ†ê/i,
        /(\d+)\s*Ï†ê/i
    ];
    
    for (const pattern of pointsPatterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
            extracted.points = match[1] + 'Ï†ê';
            break;
        }
    }
    
    // Extract location - look for submission location patterns
    const locationPatterns = [
        /Ï†úÏ∂ú\s*Ïû•ÏÜå[\s]*[:Ôºö]\s*(.+?)(?=\n|$)/i,
        /Ï†úÏ∂ú\s*Î∞©Î≤ï[\s]*[:Ôºö]\s*(.+?)(?=\n|$)/i,
        /Ï†úÏ∂ú[\s]*[:Ôºö]\s*(.+?)(?=\n|$)/i,
        /Ïû•ÏÜå[\s]*[:Ôºö]\s*(.+?)(?=\n|$)/i,
        /(Ïù¥Î©îÏùº|email)[\s]*[:Ôºö]\s*([^\s]+@[^\s]+)/i,
        /(Ïò®ÎùºÏù∏|ÏÇ¨Ïù¥Î≤Ñ|Ïõπ)/i
    ];
    
    for (const pattern of locationPatterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
            extracted.location = match[1].trim();
            break;
        } else if (match && match[2]) {
            extracted.location = match[2].trim();
            break;
        }
    }
    
    return extracted;
}

function displayExtractedInfo(extracted) {
    document.getElementById('extracted-title').textContent = extracted.title;
    document.getElementById('extracted-deadline').textContent = extracted.deadline;
    document.getElementById('extracted-points').textContent = extracted.points;
    document.getElementById('extracted-location').textContent = extracted.location;
    
    document.getElementById('extracted-info').classList.remove('hidden');
}

function saveExtractedEvent() {
    const title = document.getElementById('extracted-title').textContent;
    const deadline = document.getElementById('extracted-deadline').textContent;
    const points = document.getElementById('extracted-points').textContent;
    const location = document.getElementById('extracted-location').textContent;
    const originalText = document.getElementById('chatbot-messages').lastElementChild.previousElementSibling.querySelector('.message-content').textContent;
    
    const deadlineDate = parseDeadlineDate(deadline);
    if (!deadlineDate) {
        alert('ÎßàÍ∞êÏùºÏùÑ ÌååÏã±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
        return;
    }
    
    const eventData = {
        id: Date.now(),
        title: title,
        type: 'assignment',
        date: formatDate(deadlineDate),
        time: '23:59',
        endTime: '23:59',
        priority: 'high',
        description: `[Í≥ºÏ†ú Ï†ïÎ≥¥]\n` +
                    `Î∞∞Ï†ê: ${points}\n` +
                    `Ï†úÏ∂úÏû•ÏÜå: ${location}\n\n` +
                    `[ÏõêÎ≥∏ Í≥ºÏ†ú ÎÇ¥Ïö©]\n${originalText}`,
    };
    
    events.push(eventData);
    saveEvents();
    
    // Ìï¥Îãπ ÎÇ†ÏßúÏùò ÏõîÎ°ú Ïù¥Îèô
    currentMonth = new Date(deadlineDate);
    selectedDate = new Date(deadlineDate);
    
    // Ï∫òÎ¶∞ÎçîÏôÄ Ïù¥Î≤§Ìä∏ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
    updateCalendar();
    updateMonthDisplay();
    
    // ÏùºÏ†ï Î™©Î°ù ÌÉ≠ÏúºÎ°ú Ï†ÑÌôò
    switchTab('events');
    updateEventList();
    
    // Ï∂îÏ∂úÎêú Ï†ïÎ≥¥ Ïà®Í∏∞Í∏∞
    document.getElementById('extracted-info').classList.add('hidden');
    document.getElementById('chatbot-input').value = '';
}

function editExtractedEvent() {
    if (!extractedData) return;
    
    // Switch to events tab
    switchTab('events');
    
    // Create a temporary event object for editing
    let deadlineDate = parseDeadlineDate(extractedData.deadline);
    if (!deadlineDate) {
        deadlineDate = new Date();
        deadlineDate.setDate(deadlineDate.getDate() + 7);
    }
    
    const tempEvent = {
        id: 'temp-' + Date.now(),
        title: extractedData.title,
        type: 'assignment',
        date: deadlineDate,
        time: '23:59',
        endTime: '23:59',
        priority: 'high',
        description: `Î∞∞Ï†ê: ${extractedData.points}\nÏ†úÏ∂úÏû•ÏÜå: ${extractedData.location}`
    };
    
    showEventForm(tempEvent);
    
    // Clear extracted info
    document.getElementById('extracted-info').classList.add('hidden');
    extractedData = null;
}

function parseDeadlineDate(deadlineStr) {
    if (!deadlineStr || deadlineStr === 'Ïïå Ïàò ÏóÜÏùå') return null;
    
    // Try different date formats
    const patterns = [
        /(\d{4})[-\/ÎÖÑ]\s*(\d{1,2})[-\/Ïõî]\s*(\d{1,2})Ïùº?/,
        /(\d{1,2})\/(\d{1,2})\/(\d{4})/,
        /(\d{1,2})Ïõî\s*(\d{1,2})Ïùº/,
        /(\d{4})-(\d{1,2})-(\d{1,2})/
    ];
    
    for (const pattern of patterns) {
        const match = deadlineStr.match(pattern);
        if (match) {
            let year, month, day;
            
            if (pattern.source.includes('Ïõî')) {
                // Korean format like "12Ïõî 25Ïùº"
                month = parseInt(match[1]);
                day = parseInt(match[2]);
                year = new Date().getFullYear(); // Use current year
            } else if (pattern.source.includes('ÎÖÑ')) {
                // Korean format like "2024ÎÖÑ 12Ïõî 25Ïùº"
                year = parseInt(match[1]);
                month = parseInt(match[2]);
                day = parseInt(match[3]);
            } else if (match[3] && match[3].length === 4) {
                // US format MM/DD/YYYY
                month = parseInt(match[1]);
                day = parseInt(match[2]);
                year = parseInt(match[3]);
            } else {
                // ISO format YYYY-MM-DD
                year = parseInt(match[1]);
                month = parseInt(match[2]);
                day = parseInt(match[3]);
            }
            
            return new Date(year, month - 1, day);
        }
    }
    
    return null;
}

// Local storage functions
function saveEvents() {
    localStorage.setItem('calendar-events', JSON.stringify(events));
}

function loadEvents() {
    const savedEvents = localStorage.getItem('calendar-events');
    if (savedEvents) {
        events = JSON.parse(savedEvents);
    }
}

// ÏÉàÎ°úÏö¥ Î∂ÑÏÑù Í∏∞Îä•
function analyzeAssignment(text) {
    const keywords = {
        high: ['ÌîÑÎ°úÏ†ùÌä∏', 'Î≥¥Í≥†ÏÑú', 'ÎÖºÎ¨∏', 'Í∏∞Îßê', 'Î∞úÌëú'],
        medium: ['Î†àÌè¨Ìä∏', 'ÏöîÏïΩ', 'Ï°∞ÏÇ¨', 'Ïã§Ïäµ'],
        low: ['ÌÄ¥Ï¶à', 'Ïó∞Ïäµ', 'Í∞ÑÎã®Ìïú']
    };
    
    let difficulty = 'medium';
    let estimatedHours = 2;
    
    text = text.toLowerCase();
    
    if (keywords.high.some(word => text.includes(word))) {
        difficulty = 'high';
        estimatedHours = 5;
    } else if (keywords.low.some(word => text.includes(word))) {
        difficulty = 'low';
        estimatedHours = 1;
    }
    
    return { difficulty, estimatedHours };
}

// ÏûëÏóÖÏùº Í≥ÑÏÇ∞ Í∏∞Îä•
function calculateWorkingDays(deadline) {
    const today = new Date();
    const diff = deadline - today;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    let workingDays = days;
    let currentDate = new Date(today);
    
    for (let i = 0; i < days; i++) {
        currentDate.setDate(currentDate.getDate() + 1);
        if (currentDate.getDay() === 0 || currentDate.getDay() === 6) {
            workingDays--;
        }
    }
    
    return workingDays;
}

// Ïö∞ÏÑ†ÏàúÏúÑ Í≥ÑÏÇ∞ Í∏∞Îä•
function calculatePriority(assignment) {
    const now = new Date();
    const deadline = new Date(assignment.date);
    const daysLeft = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
    
    // Í∏∞Î≥∏ Ï†êÏàò Í≥ÑÏÇ∞
    let score = 0;
    
    // ÎßàÍ∞êÏùº Í∞ÄÏ§ëÏπò (40%)
    score += (10 - Math.min(daysLeft, 10)) * 0.4;
    
    // Í≥ºÏ†ú ÌÉÄÏûÖ Í∞ÄÏ§ëÏπò (30%)
    if (assignment.type === 'exam') score += 0.3;
    else if (assignment.type === 'assignment') score += 0.25;
    else score += 0.15;
    
    // ÏÑ§Î™Ö Í∏∏Ïù¥ Í∞ÄÏ§ëÏπò (30%)
    const descriptionLength = (assignment.description || '').length;
    score += Math.min(descriptionLength / 1000, 1) * 0.3;
    
    return score > 0.7 ? 'high' : score > 0.4 ? 'medium' : 'low';
}

// Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÏÉùÏÑ± Í∏∞Îä•
function generateChecklist(type) {
    const templates = {
        assignment: [
            'ÏûêÎ£å Ï°∞ÏÇ¨ Î∞è ÏàòÏßë',
            'Í∞úÏöî ÏûëÏÑ±',
            'Ï¥àÏïà ÏûëÏÑ±',
            'Í≤ÄÌÜ† Î∞è ÏàòÏ†ï',
            'ÏµúÏ¢Ö Ï†úÏ∂ú'
        ],
        exam: [
            'ÌïôÏäµ Í≥ÑÌöç ÏàòÎ¶Ω',
            'Ï£ºÏöî ÎÇ¥Ïö© Ï†ïÎ¶¨',
            'Ïó∞Ïäµ Î¨∏Ï†ú ÌíÄÏù¥',
            'Ïò§Îãµ ÎÖ∏Ìä∏ ÏûëÏÑ±',
            'ÏµúÏ¢Ö Î≥µÏäµ'
        ],
        default: [
            'Í≥ÑÌöç ÏàòÎ¶Ω',
            'Ï§ÄÎπÑ',
            'Ïã§Ìñâ',
            'Í≤ÄÌÜ†',
            'ÏôÑÎ£å'
        ]
    };
    
    return templates[type] || templates.default;
}

// ÏßÑÌñâ ÏÉÅÌô© Ï∂îÏ†Å Í∏∞Îä•
function trackProgress(assignment) {
    const checklist = JSON.parse(localStorage.getItem(`checklist-${assignment.id}`) || '[]');
    const completedTasks = checklist.filter(task => task.completed).length;
    const totalTasks = checklist.length || 1;
    
    const progress = (completedTasks / totalTasks) * 100;
    const deadline = new Date(assignment.date);
    const totalDays = calculateWorkingDays(deadline);
    
    const expectedProgress = Math.max(0, Math.min(100, 
        (1 - (totalDays / (totalDays + 1))) * 100
    ));
    
    return {
        currentProgress: progress,
        expectedProgress,
        isDelayed: progress < expectedProgress,
        warningLevel: progress < expectedProgress - 20 ? 'high' : 'low'
    };
}

// ÏïåÎ¶º ÏãúÏä§ÌÖú
class NotificationSystem {
    constructor() {
        this.initialized = false;
        this.setup();
    }
    
    async setup() {
        if ('Notification' in window) {
            const permission = await Notification.requestPermission();
            this.initialized = permission === 'granted';
        }
    }
    
    createReminder(assignment) {
        if (!this.initialized) return;
        
        const deadline = new Date(assignment.date);
        const now = new Date();
        
        // ÎßàÍ∞ê 24ÏãúÍ∞Ñ Ï†Ñ ÏïåÎ¶º
        if (deadline - now <= 24 * 60 * 60 * 1000) {
            new Notification('Í≥ºÏ†ú ÎßàÍ∞ê ÏûÑÎ∞ï!', {
                body: `${assignment.title}Ïù¥(Í∞Ä) 24ÏãúÍ∞Ñ ÎÇ¥Ïóê ÎßàÍ∞êÎê©ÎãàÎã§.`,
                icon: '/favicon.ico'
            });
        }
    }
}